<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Collector & Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for the table container */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Smooth fade in */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen font-sans">

    <!-- Loading Overlay -->
    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-500 font-medium">Connecting to Firebase...</p>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform translate-x-full transition-transform duration-300 bg-white border-l-4 p-4 rounded shadow-lg flex items-center gap-3 max-w-xs">
        <div id="toast-icon"></div>
        <div class="flex-1">
            <h4 id="toast-title" class="font-bold text-sm">Notification</h4>
            <p id="toast-message" class="text-xs text-gray-600"></p>
        </div>
        <button onclick="hideToast()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
    </div>

    <div class="max-w-4xl mx-auto p-4 md:p-6">
        
        <!-- Header & Nav -->
        <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fas fa-address-book text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">ContactHub</h1>
                    <p class="text-xs text-gray-500" id="connection-status">Initializing...</p>
                </div>
            </div>
            
            <div class="flex bg-gray-100 p-1 rounded-xl w-full sm:w-auto">
                <button onclick="switchTab('form')" id="tab-form" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-white text-blue-600 shadow-sm">
                    <i class="fas fa-pen mr-2"></i>Register
                </button>
                <button onclick="switchTab('admin')" id="tab-admin" class="flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-medium text-gray-500 hover:text-gray-700 transition-all duration-200">
                    <i class="fas fa-shield-alt mr-2"></i>Admin
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="relative">
            
            <!-- FORM VIEW -->
            <div id="view-form" class="fade-in bg-white rounded-2xl shadow-sm overflow-hidden">
                <div class="bg-blue-600 p-6 text-white text-center">
                    <h2 class="text-2xl font-bold mb-2">Join Our List</h2>
                    <p class="text-blue-100">Please fill in your details below.</p>
                </div>
                
                <form id="contactForm" class="p-6 md:p-8 space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-700 ml-1">Full Name</label>
                            <div class="relative">
                                <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="text" id="name" required class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="John Doe">
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-sm font-semibold text-gray-700 ml-1">Phone Number</label>
                            <div class="relative">
                                <i class="fas fa-phone absolute left-3 top-3.5 text-gray-400"></i>
                                <input type="tel" id="phone" required class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="+1 (555) 000-0000">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-sm font-semibold text-gray-700 ml-1">Email Address</label>
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
                            <input type="email" id="email" required class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="john@example.com">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-sm font-semibold text-gray-700 ml-1">Additional Notes</label>
                        <textarea id="notes" rows="3" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none" placeholder="Any specific requirements?"></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transform transition hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                        Submit Registration
                    </button>
                </form>
            </div>

            <!-- ADMIN VIEW -->
            <div id="view-admin" class="hidden fade-in bg-white rounded-2xl shadow-sm flex flex-col h-[600px]">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Submission Records</h2>
                        <p class="text-sm text-gray-500" id="record-count">Loading records...</p>
                    </div>
                    <button onclick="refreshData()" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition-colors" title="Force Refresh">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-auto p-4 relative" id="admin-content">
                    <!-- Cards will be injected here -->
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>Waiting for data...</p>
                    </div>
                </div>
            </div>

        </main>
        
        <footer class="mt-8 text-center text-gray-400 text-sm">
            <p>&copy; 2025 ContactHub. Securely powered by Firebase.</p>
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        // Priority: 1. Environment Variable, 2. User Provided Fallback
        const fallbackConfig = {
            apiKey: "AIzaSyAYC8OPdjZLK9Yxi3LXjYiiUCu_KbNWEa8",
            authDomain: "prajyot-7215d.firebaseapp.com",
            databaseURL: "https://prajyot-7215d-default-rtdb.firebaseio.com",
            projectId: "prajyot-7215d",
            storageBucket: "prajyot-7215d.firebasestorage.app",
            messagingSenderId: "328603151061",
            appId: "1:328603151061:web:16535eb023dbf7df86d05c",
            measurementId: "G-L7XB5FBCWP"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribeListeners = null;

        // --- Auth Flow ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                showToast("Auth Failed", "Could not sign in anonymously.", "error");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('connection-status').innerText = "Connected";
                document.getElementById('connection-status').classList.add('text-green-500');
                
                // Start listening to data immediately
                setupRealtimeListener();
            } else {
                document.getElementById('connection-status').innerText = "Disconnected";
                document.getElementById('connection-status').classList.remove('text-green-500');
            }
        });

        // --- Database Logic ---
        
        // Save Data (Public Form)
        document.getElementById('contactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return showToast("Error", "Not connected to server.", "error");

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                notes: document.getElementById('notes').value,
                createdAt: serverTimestamp(),
                userId: currentUser.uid // Storing who created it for reference
            };

            try {
                // Rule 1: Using the safe path structure
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
                await addDoc(collectionRef, formData);
                
                showToast("Success!", "Registration saved successfully.", "success");
                document.getElementById('contactForm').reset();
            } catch (error) {
                console.error("Save Error:", error);
                showToast("Error", "Failed to save data. Try again.", "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Read Data (Admin View)
        function setupRealtimeListener() {
            if (!currentUser) return;
            if (unsubscribeListeners) unsubscribeListeners(); // Clear old listeners if any

            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'registrations');
            // Rule 2: Simple query, no 'orderBy' in the query itself to avoid index errors
            const q = query(collectionRef);

            const contentDiv = document.getElementById('admin-content');
            const countLabel = document.getElementById('record-count');

            unsubscribeListeners = onSnapshot(q, (snapshot) => {
                const submissions = [];
                snapshot.forEach(doc => {
                    submissions.push({ id: doc.id, ...doc.data() });
                });

                // Sort in memory (Rule 2 compliance) - Newest first
                submissions.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                countLabel.innerText = `${submissions.length} Record(s) Found`;
                renderAdminList(submissions);

                // Spin the refresh icon briefly to show activity
                const icon = document.getElementById('refresh-icon');
                icon.classList.add('fa-spin');
                setTimeout(() => icon.classList.remove('fa-spin'), 500);

            }, (error) => {
                console.error("Listener Error:", error);
                contentDiv.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-red-400">
                        <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                        <p>Error loading data.</p>
                        <p class="text-xs text-gray-400 mt-2">${error.message}</p>
                    </div>
                `;
            });
        }

        function renderAdminList(data) {
            const container = document.getElementById('admin-content');
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                        <p>No submissions yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `<div class="space-y-3 pb-4">
                ${data.map(item => `
                    <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow relative group">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">${escapeHtml(item.name || 'Unknown')}</h3>
                                <div class="flex items-center gap-4 text-sm text-gray-500 mt-1">
                                    <span class="flex items-center gap-1"><i class="fas fa-phone text-xs"></i> ${escapeHtml(item.phone || 'N/A')}</span>
                                    <span class="flex items-center gap-1"><i class="fas fa-envelope text-xs"></i> ${escapeHtml(item.email || 'N/A')}</span>
                                </div>
                            </div>
                            <span class="text-xs font-mono text-gray-400 bg-gray-50 px-2 py-1 rounded">
                                ${item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}
                            </span>
                        </div>
                        
                        ${item.notes ? `
                            <div class="mt-3 pt-3 border-t border-gray-50 text-sm text-gray-600 bg-gray-50/50 p-2 rounded-lg">
                                <span class="font-semibold text-xs text-gray-400 uppercase tracking-wider">Note:</span>
                                <p class="mt-1 italic">"${escapeHtml(item.notes)}"</p>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Start App ---
        initAuth();

        // --- UI Helper Functions exposed to window for HTML onClick ---
        window.switchTab = function(tabName) {
            const formView = document.getElementById('view-form');
            const adminView = document.getElementById('view-admin');
            const formTab = document.getElementById('tab-form');
            const adminTab = document.getElementById('tab-admin');

            if (tabName === 'form') {
                formView.classList.remove('hidden');
                adminView.classList.add('hidden');
                
                formTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                formTab.classList.remove('text-gray-500');
                
                adminTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                adminTab.classList.add('text-gray-500');
            } else {
                formView.classList.add('hidden');
                adminView.classList.remove('hidden');

                adminTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                adminTab.classList.remove('text-gray-500');
                
                formTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                formTab.classList.add('text-gray-500');
            }
        };

        window.refreshData = function() {
            setupRealtimeListener();
        };

        // Toast System
        window.showToast = function(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastTitle.innerText = title;
            toastMessage.innerText = message;

            if (type === 'success') {
                toast.classList.add('border-green-500');
                toast.classList.remove('border-red-500');
                toastIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xl"></i>';
            } else {
                toast.classList.add('border-red-500');
                toast.classList.remove('border-green-500');
                toastIcon.innerHTML = '<i class="fas fa-times-circle text-red-500 text-xl"></i>';
            }

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        };

        window.hideToast = function() {
            document.getElementById('toast').classList.add('translate-x-full');
        };

    </script>
</body>
</html>
